name: CI - TypeCheck, Lint, Test & Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript type checking
        run: npm run typecheck

  lint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      issues: write
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Start DynamoDB manually
        run: |
          docker run -d \
            --name dynamodb \
            -p 8000:8000 \
            --user root \
            amazon/dynamodb-local:latest \
            -jar DynamoDBLocal.jar -sharedDb -inMemory
          
          echo "Checking DynamoDB container status..."
          echo "=== docker ps ==="
          docker ps --filter name=dynamodb --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "=== docker inspect ==="
          docker inspect dynamodb --format '{{json .}}' | jq '{
            Id: .Id,
            State: .State.Status,
            Running: .State.Running,
            Paused: .State.Paused,
            Restarting: .State.Restarting,
            StartedAt: .State.StartedAt,
            NetworkSettings: {
              IPAddress: .NetworkSettings.IPAddress,
              Ports: .NetworkSettings.Ports
            },
            Config: {
              User: .Config.User,
              Cmd: .Config.Cmd,
              Entrypoint: .Config.Entrypoint
            }
          }' || docker inspect dynamodb
          
          echo ""
          echo "Waiting for DynamoDB to start..."
          for i in {1..30}; do
            # Check container is running
            if ! docker ps --filter name=dynamodb --format "{{.Names}}" | grep -q dynamodb; then
              echo "âš  DynamoDB container is not running!"
              docker ps -a --filter name=dynamodb
              docker logs dynamodb || true
              exit 1
            fi
            
            # Check if DynamoDB is accessible (use ListTables API call for proper 200 response)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/ \
              -H "Content-Type: application/x-amz-json-1.0" \
              -H "X-Amz-Target: DynamoDB_20120810.ListTables" \
              -d '{}' 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ“ DynamoDB is ready! (HTTP $HTTP_CODE)"
              docker ps --filter name=dynamodb
              break
            elif [ "$HTTP_CODE" = "400" ]; then
              # 400 also means DynamoDB is running (invalid request format)
              echo "âœ“ DynamoDB is responding! (HTTP $HTTP_CODE - service is up)"
              docker ps --filter name=dynamodb
              break
            fi
            echo "Waiting for DynamoDB... ($i/30)"
            sleep 2
          done
          
          # Final check with proper API call
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/ \
            -H "Content-Type: application/x-amz-json-1.0" \
            -H "X-Amz-Target: DynamoDB_20120810.ListTables" \
            -d '{}' 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "400" ]; then
            echo "âŒ DynamoDB failed to start (HTTP $HTTP_CODE)"
            echo "=== Container logs ==="
            docker logs dynamodb || true
            echo "=== Container inspect ==="
            docker inspect dynamodb || true
            exit 1
          else
            echo "âœ“ DynamoDB is ready! (HTTP $HTTP_CODE)"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Save unit test coverage
        run: |
          mkdir -p coverage-reports
          cp coverage/coverage-summary.json coverage-reports/unit-coverage.json
          cp coverage/cobertura-coverage.xml coverage-reports/unit-cobertura.xml
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          REDIS_ENABLED: 'true'
          REDIS_URL: 'redis://localhost:6379'
          REDIS_PREFIX: 'test:'
          REDIS_TTL: '300'
          DYNAMODB_ENABLED: 'true'
          DYNAMODB_ENDPOINT: 'http://localhost:8000'
          DYNAMODB_CIRCUIT_BREAKER_COOLDOWN: '5000'
          AWS_REGION: 'us-east-1'
          AWS_ACCESS_KEY_ID: 'test'
          AWS_SECRET_ACCESS_KEY: 'test'
      
      - name: Save integration test coverage
        run: |
          cp coverage/coverage-summary.json coverage-reports/integration-coverage.json
          cp coverage/cobertura-coverage.xml coverage-reports/integration-cobertura.xml
      
      - name: Generate combined coverage report
        run: |
          # Extract coverage metrics
          UNIT_LINES=$(jq '.total.lines.pct' coverage-reports/unit-coverage.json)
          UNIT_STMTS=$(jq '.total.statements.pct' coverage-reports/unit-coverage.json)
          UNIT_BRANCHES=$(jq '.total.branches.pct' coverage-reports/unit-coverage.json)
          UNIT_FUNCS=$(jq '.total.functions.pct' coverage-reports/unit-coverage.json)
          
          INT_LINES=$(jq '.total.lines.pct' coverage-reports/integration-coverage.json)
          INT_STMTS=$(jq '.total.statements.pct' coverage-reports/integration-coverage.json)
          INT_BRANCHES=$(jq '.total.branches.pct' coverage-reports/integration-coverage.json)
          INT_FUNCS=$(jq '.total.functions.pct' coverage-reports/integration-coverage.json)
          
          # Create coverage table
          cat > coverage-table.md << EOF
          ## ðŸ“Š Test Coverage Report
          
          | Suite | Lines | Statements | Branches | Functions |
          |-------|-------|------------|----------|-----------|
          | **Unit Tests** | ${UNIT_LINES}% | ${UNIT_STMTS}% | ${UNIT_BRANCHES}% | ${UNIT_FUNCS}% |
          | **Integration Tests** | ${INT_LINES}% | ${INT_STMTS}% | ${INT_BRANCHES}% | ${INT_FUNCS}% |
          
          > ðŸ“ Unit tests exclude integration tests and run with mocked dependencies.
          > 
          > ðŸ”§ Integration tests verify Redis and DynamoDB functionality with real service instances.
          EOF
      
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-reports/unit-cobertura.xml,./coverage-reports/integration-cobertura.xml
          flags: unittests,integrationtests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: coverage-table.md
      
      - name: Write coverage to Job Summary
        run: cat coverage-table.md >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports
          path: coverage-reports/
          retention-days: 7

  build:
    name: Build Next.js Application
    runs-on: ubuntu-latest
    needs: [typecheck, lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts
          path: |
            .next/
            !.next/cache
          retention-days: 7
