name: CI - TypeCheck, Lint, Test & Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript type checking
        run: npm run typecheck

  lint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      issues: write
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      dynamodb:
        image: amazon/dynamodb-local:latest
        ports:
          - 8000:8000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Save unit test coverage
        run: |
          mkdir -p coverage-reports
          cp coverage/coverage-summary.json coverage-reports/unit-coverage.json
          cp coverage/cobertura-coverage.xml coverage-reports/unit-cobertura.xml
      
      - name: Wait for DynamoDB to be ready
        run: |
          echo "Waiting for DynamoDB Local to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "DynamoDB Local is ready!"
              exit 0
            fi
            echo "Attempt $i/30: DynamoDB not ready yet, waiting..."
            sleep 2
          done
          echo "DynamoDB Local failed to start"
          exit 1
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          REDIS_ENABLED: 'true'
          REDIS_URL: 'redis://localhost:6379'
          REDIS_PREFIX: 'test:'
          REDIS_TTL: '300'
          DYNAMODB_ENABLED: 'true'
          DYNAMODB_ENDPOINT: 'http://localhost:8000'
          DYNAMODB_CIRCUIT_BREAKER_COOLDOWN: '5000'
          AWS_REGION: 'us-east-1'
          AWS_ACCESS_KEY_ID: 'test'
          AWS_SECRET_ACCESS_KEY: 'test'
      
      - name: Save integration test coverage
        run: |
          cp coverage/coverage-summary.json coverage-reports/integration-coverage.json
          cp coverage/cobertura-coverage.xml coverage-reports/integration-cobertura.xml
      
      - name: Generate combined coverage report
        run: |
          # Extract coverage metrics
          UNIT_LINES=$(jq '.total.lines.pct' coverage-reports/unit-coverage.json)
          UNIT_STMTS=$(jq '.total.statements.pct' coverage-reports/unit-coverage.json)
          UNIT_BRANCHES=$(jq '.total.branches.pct' coverage-reports/unit-coverage.json)
          UNIT_FUNCS=$(jq '.total.functions.pct' coverage-reports/unit-coverage.json)
          
          INT_LINES=$(jq '.total.lines.pct' coverage-reports/integration-coverage.json)
          INT_STMTS=$(jq '.total.statements.pct' coverage-reports/integration-coverage.json)
          INT_BRANCHES=$(jq '.total.branches.pct' coverage-reports/integration-coverage.json)
          INT_FUNCS=$(jq '.total.functions.pct' coverage-reports/integration-coverage.json)
          
          # Create coverage table
          cat > coverage-table.md << EOF
          ## ðŸ“Š Test Coverage Report
          
          | Suite | Lines | Statements | Branches | Functions |
          |-------|-------|------------|----------|-----------|
          | **Unit Tests** | ${UNIT_LINES}% | ${UNIT_STMTS}% | ${UNIT_BRANCHES}% | ${UNIT_FUNCS}% |
          | **Integration Tests** | ${INT_LINES}% | ${INT_STMTS}% | ${INT_BRANCHES}% | ${INT_FUNCS}% |
          
          > ðŸ“ Unit tests exclude integration tests and run with mocked dependencies.
          > 
          > ðŸ”§ Integration tests verify Redis and DynamoDB functionality with real service instances.
          EOF
      
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-reports/unit-cobertura.xml,./coverage-reports/integration-cobertura.xml
          flags: unittests,integrationtests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: coverage-table.md
      
      - name: Write coverage to Job Summary
        run: cat coverage-table.md >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports
          path: coverage-reports/
          retention-days: 7

  build:
    name: Build Next.js Application
    runs-on: ubuntu-latest
    needs: [typecheck, lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts
          path: |
            .next/
            !.next/cache
          retention-days: 7
